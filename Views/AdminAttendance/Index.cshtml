@model Mess_Management_System.Models.AdminAttendanceViewModel

@{
    ViewBag.Title = "Attendance Management";
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-20px)' },
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-white text-gray-900 min-h-screen">

    <partial name="_TopNavbar" />
    <partial name="_SideDrawer" />

    <script>
        // Store browser-local date in a cookie and populate hidden clientDate input
        (function() {
            try {
                var iso = new Date().toISOString().split('T')[0];
                // set cookie for whole site
                document.cookie = 'clientDate=' + iso + '; path=/';
                var clientDateInput = document.getElementById('clientDate');
                if (clientDateInput) clientDateInput.value = iso;
            } catch (e) {
                // fail silently
            }
        })();
    </script>

    <!-- Main Content Area -->
    <div class="pt-16">

            <!-- Top Header -->
            <header class="bg-white border-b border-gray-200 px-8 py-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-4xl font-extrabold text-gray-900">
                            Attendance Management
                        </h1>
                        @{
                            var displayDate = Model.TodayMenu?.FirstOrDefault()?.Date.Date ?? DateTime.Now.Date;
                        }
                        <p class="text-gray-600 mt-2 text-lg">
                            Mark attendance for today's menu — <span id="menuDateDisplay">@displayDate.ToString("MMMM dd, yyyy")</span>
                        </p>
                    </div>
                    <div class="flex space-x-4">
                        <form id="autoMarkForm" method="post" asp-action="AutoMarkDrinks" class="inline">
                            <input type="hidden" id="clientDate" name="clientDate" />
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 transition shadow-sm flex items-center font-medium">
                                <i class="fas fa-mug-hot mr-2"></i>
                                Auto-Mark Drinks
                            </button>
                        </form>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <main class="flex-1 overflow-y-auto p-8">

                <!-- Messages -->
                @if (TempData["SuccessMessage"] != null)
                {
                    <div class="mb-8 p-6 bg-gradient-to-r bg-green-50 border border-green-500/30 rounded-lg flex items-center shadow-sm">
                        <i class="fas fa-check-circle text-green-600 text-4xl mr-6"></i>
                        <span class="text-green-800 text-xl font-medium">@TempData["SuccessMessage"]</span>
                    </div>
                }

                @if (TempData["ErrorMessage"] != null)
                {
                    <div class="mb-8 p-6 bg-gradient-to-r bg-red-50 border border-red-500/30 rounded-lg flex items-center shadow-sm">
                        <i class="fas fa-exclamation-circle text-red-400 text-4xl mr-6"></i>
                        <span class="text-red-700 text-xl font-medium">@TempData["ErrorMessage"]</span>
                    </div>
                }

                <!-- No Menu Warning -->
                @if (Model.TodayMenu == null || Model.TodayMenu.Count == 0)
                {
                    <div class="bg-gray-50 rounded-lg p-16 text-center border border-amber-500/30 shadow-sm">
                        <i class="fas fa-utensils text-8xl text-gray-600 mb-8"></i>
                        <h3 class="text-3xl font-bold text-gray-700 mb-4">No Menu Items for Today</h3>
                        <p class="text-gray-600 text-lg mb-8">Please add menu items before marking attendance.</p>
                        <a href="/AdminMenu/Add" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 transition shadow-sm inline-flex items-center font-medium">
                            <i class="fas fa-plus mr-2"></i>
                            Add Items
                        </a>
                    </div>
                }
                else
                {
                    <!-- Summary Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium">Total Users</p>
                                    <p class="text-2xl font-semibold mt-1 text-gray-900">@Model.Users.Count</p>
                                </div>
                                <svg class="w-10 h-10 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM9 6a3 3 0 11-6 0 3 3 0 016 0zM9 10a3 3 0 11-6 0 3 3 0 016 0zm5.5-1a2.5 2.5 0 100-5 2.5 2.5 0 000 5zM18 16a4 4 0 00-8 0v2h8v-2z"/>
                                </svg>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium">Menu Items Today</p>
                                    <p class="text-2xl font-semibold mt-1 text-gray-900">@Model.TodayMenu.Count</p>
                                </div>
                                <svg class="w-10 h-10 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M8.5 1a1 1 0 11-2 0 1 1 0 012 0zM4 4a2 2 0 100 4 2 2 0 000-4zM2 9a1 1 0 100 2 1 1 0 000-2zm8-6a1 1 0 11-2 0 1 1 0 012 0zM4.5 13a2 2 0 100 4 2 2 0 000-4zM2 17a1 1 0 100 2 1 1 0 000-2zm10-8a1 1 0 11-2 0 1 1 0 012 0zM11 7a2 2 0 100-4 2 2 0 000 4zm-1 7a2 2 0 11-4 0 2 2 0 014 0zM14 9a1 1 0 11-2 0 1 1 0 012 0zM15 19a1 1 0 100-2 1 1 0 000 2zm2-10a2 2 0 100-4 2 2 0 000 4z"/>
                                </svg>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium">Attendance Marked</p>
                                    <p class="text-2xl font-semibold mt-1 text-gray-900">@(Model.Attendances?.Count(a => a.Attended) ?? 0)</p>
                                </div>
                                <svg class="w-10 h-10 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- Attendance Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        @foreach (var user in Model.Users)
                        {
                            <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="font-semibold text-gray-900 text-lg">@user.FullName</p>
                                        <p class="text-sm text-gray-500">@user.Email</p>
                                    </div>
                                    <div class="text-sm text-gray-400">ID: @user.Id</div>
                                </div>

                                <div class="mt-4 space-y-3">
                                    @foreach (var menu in Model.TodayMenu)
                                    {
                                        var isAttended = Model.Attendances?.Any(a => a.UserId == user.Id && a.MenuId == menu.Id && a.Attended) ?? false;
                                        <div class="flex items-center justify-between bg-gray-50 rounded-md p-3 border border-gray-100">
                                            <div>
                                                <p class="font-medium text-gray-700">@menu.Name <span class="text-sm text-gray-500">• Rs @menu.Price</span></p>
                                                <p class="text-xs text-gray-400">@(menu.IsFood ? "Optional" : "Mandatory")</p>
                                            </div>
                                            <label class="relative inline-flex items-center cursor-pointer group">
                                                <input type="checkbox" class="attendance-checkbox sr-only peer" data-user-id="@user.Id" data-menu-id="@menu.Id" @(isAttended ? "checked" : "")>
                                                <div class="w-16 h-9 bg-gray-600/50 rounded-full peer peer-checked:bg-gradient-to-r peer-checked:from-emerald-600 peer-checked:to-teal-600 after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:rounded-full after:h-7 after:w-7 after:transition-all peer-checked:after:translate-x-7 shadow-inner"></div>
                                            </label>
                                        </div>
                                    }
                                </div>

                            </div>
                        }
                    </div>
                }

            </main>
        </div>
    </div>

    <!-- jQuery AJAX for Real-time Attendance -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            $('.attendance-checkbox').on('change', function() {
                var checkbox = $(this);
                var userId = checkbox.data('user-id');
                var menuId = checkbox.data('menu-id');
                var attended = checkbox.is(':checked');

                checkbox.prop('disabled', true);

                $.ajax({
                    url: '/AdminAttendance/MarkAttendance',
                    type: 'POST',
                    data: { userId: userId, menuId: menuId, attended: attended },
                    success: function(response) {
                        if (response.success) {
                            showNotification('Success', response.message, 'success');
                        } else {
                            checkbox.prop('checked', !attended);
                            showNotification('Error', response.message, 'error');
                        }
                    },
                    error: function() {
                        checkbox.prop('checked', !attended);
                        showNotification('Error', 'Failed to update attendance. Please try again.', 'error');
                    },
                    complete: function() {
                        checkbox.prop('disabled', false);
                    }
                });
            });

            function showNotification(title, message, type) {
                var bgGradient = type === 'success' 
                    ? 'bg-green-600' 
                    : 'bg-red-600';

                var notification = $(`
                    <div class="fixed top-8 right-8 bg-gradient-to-r ${bgGradient} text-white px-8 py-6 rounded-lg shadow-sm z-50 max-w-sm animate-slide-in">
                        <p class="text-2xl font-bold mb-2">${title}</p>
                        <p class="text-lg">${message}</p>
                    </div>
                `);

                $('body').append(notification);

                setTimeout(() => {
                    notification.fadeOut(500, function() { $(this).remove(); });
                }, 4000);
            }
        });
    </script>

    <!-- Browser-local date text removed; cookie still set at top for cross-page usage. -->

    <style>
        @@keyframes slide-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .animate-slide-in { animation: slide-in 0.4s ease-out; }
        .shadow-glow { box-shadow: 0 0 20px rgba(6, 182, 212, 0.4); }
    </style>

    </div>

</body>
</html>